// Generated by CoffeeScript 2.7.0
var PREFIX, consola, fs, isImportContext, path, pathRegex, pkg, replaceExt, suffixRegex;

fs = require('fs');

path = require('path');

consola = require('consola');

pkg = require('../package.json');

PREFIX = `[${pkg.name}]`;

pathRegex = /(['"`])((?:\.{1,2}\/|\/)[^"'`]*?\.(?:lit)?coffee)\1/g;

suffixRegex = /(['"])(\.(?:lit)?coffee)\1/g;

isImportContext = function(fullText, offset) {
  var currentLine, i, lastLineBreak, lineEnd, lineStart, trimmedLine;
  if (typeof fullText !== 'string') {
    return false;
  }
  lastLineBreak = fullText.lastIndexOf('\n', offset);
  lineStart = lastLineBreak === -1 ? 0 : lastLineBreak + 1;
  lineEnd = fullText.indexOf('\n', offset);
  if (lineEnd === -1) {
    lineEnd = fullText.length;
  }
  currentLine = fullText.substring(lineStart, lineEnd);
  trimmedLine = currentLine.trim();
  if (trimmedLine.startsWith('//' || trimmedLine.startsWith('*' || trimmedLine.startsWith('/*')))) {
    return false;
  }
  if (!/\b(require|import)\b/.test(currentLine)) {
    return false;
  }
  i = offset - 1;
  while (i >= 0 && /\s/.test(fullText[i])) {
    i--;
  }
  if (fullText[i] === 's') {
    i--;
    if (fullText[i] === 'i') {
      i--;
      if (i < 0 || /\s/.test(fullText[i])) {
        consola.trace("Skipping (found \"is\" keyword):", currentLine.substring(i + 1, offset + 10));
        return false;
      }
    }
  }
  return true;
};

replaceExt = function(options = {}) {
  return function(compilationResult) {
    var compiledFiles, config, content, error, file, fileChanged, isTargetFile, j, len, originalContent, outputFile, processedCount, ref, ref1;
    consola.info(`${PREFIX} Running...`);
    ({compiledFiles, config} = compilationResult);
    // join
    if ((ref = config.options) != null ? ref.join : void 0) {
      outputFile = path.resolve(process.cwd(), config.output);
      if (!outputFile.endsWith('.js')) {
        outputFile += '.js';
      }
      if (compiledFiles == null) {
        compiledFiles = [];
      }
      if (!compiledFiles.includes(outputFile)) {
        compiledFiles.push(outputFile);
      }
    }
    if (!compiledFiles || compiledFiles.length === 0) {
      consola.warn(`${PREFIX} No compiled files found to process.`);
      return;
    }
    processedCount = 0;
    for (j = 0, len = compiledFiles.length; j < len; j++) {
      file = compiledFiles[j];
      isTargetFile = file.endsWith('.js' || (((ref1 = config.options) != null ? ref1.join : void 0) && path.resolve(file === path.resolve(process.cwd(), config.output))));
      if (!isTargetFile) {
        continue;
      }
      try {
        content = fs.readFileSync(file, 'utf-8');
        originalContent = content;
        fileChanged = false;
        content = content.replace(pathRegex, function(match, quote, matchedPath, offset, fullText) {
          var newPath;
          if (isImportContext(fullText, offset)) {
            newPath = matchedPath.replace(/\.(lit)?coffee$/, '.js');
            if (matchedPath !== newPath) {
              fileChanged = true;
              consola.trace(`${PREFIX} Replacing (path) in ${path.basename(file)}: ${matchedPath} -> ${newPath}`);
              return `${quote}${newPath}${quote}`;
            }
          }
          return match;
        });
        content = content.replace(suffixRegex, function(match, quote, matchedPath, offset, fullText) {
          var newPath;
          if (isImportContext(fullText, offset)) {
            newPath = matchedPath.replace(/\.(lit)?coffee$/, '.js');
            if (matchedPath !== newPath) {
              fileChanged = true;
              consola.trace(`${PREFIX} Replacing (suffix) in ${path.basename(file)}: ${matchedPath} -> ${newPath}`);
              return `${quote}${newPath}${quote}`;
            }
          }
          return match;
        });
        if (fileChanged && content !== originalContent) {
          fs.writeFileSync(file, content, 'utf-8');
          processedCount++;
        }
      } catch (error1) {
        error = error1;
        consola.error(`${PREFIX} Failed to process file ${file}:`, error);
      }
    }
    if (processedCount > 0) {
      return consola.success(`${PREFIX} Processed and updated ${processedCount} file(s).`);
    } else {
      return consola.info(`${PREFIX} No files needed replacement.`);
    }
  };
};

module.exports = replaceExt;
